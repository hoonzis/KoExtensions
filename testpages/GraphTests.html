<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"> 
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF8">
        <title>Charting Test Page</title>
        <script src="../Scripts/require.js"></script>
        <link type="text/css" rel="stylesheet" href="../styles/kostyles.css" />
    </head>
<body>
	<h2>Last Week Sales:</h2>
	<div id="carsChart" data-bind="piechart: carsChart">
	</div>

	<h2>Monthly Sales</h2>
    <div id="monthlySales" data-bind="barchart: carSales, chartOptions:{legend:true, width:800,height:300,style:'stack',xcoord:'month'}">

    </div>

	<h2>Monthly Sales</h2>
	<div id="monthlySales2" data-bind="barchart: carSales,chartOptions:{legend:true, width:800,height:300,style:'bar',xcoord:'month',unitTransform:valueToLabel}">

	</div>

	<h2>Sales Per Month - 3 normalized series</h2>
	<div id="lineChart" data-bind="linechart: salesPerMonthChart, chartOptions:{height:300,width:800,normalizeSeries:true, xAxisTextAngle:45}">

	</div>

    <div id="lineChart" data-bind="linechart: simpleLine, chartOptions:{height:300,width:800,showDataPoints:false,yMin:-100,xTick:10}">
        s
    </div>

	<h2>Sales per car mark</h2>
	 <!-- ko foreach: cars -->
	 	<div style="float:left;margin-right:10px">
		 	<h3 data-bind="text:name"></h3>
			<div data-bind="piechart: salesChart">

			</div>
	 	</div> 
	 <!-- /ko -->
        <script>

            window.document.onload = function (e) {
                initialize();
            }

            require.config({
                baseUrl: "/Scripts",
                urlArgs: "bust=2" + (new Date()).getTime()
            });

            require(['knockout-3.2.0.debug', 'd3'], function(kol, d3l) {
                ko = kol;
                d3 = d3l;
                require(['KoExtensions/koextensions'], function(koext) {
                    koext.registerExtensions();
                    var carSales = [
                        {
                            month: 'january',
                            peugot: 100,
                            audit: 200,
                            bmw: 300
                        },
                        {
                            month: 'february',
                            peugot: 50,
                            audit: 110,
                            bmw: 80
                        },
                        {
                            month: 'marz',
                            peugot: 120,
                            audit: 230,
                            bmw: 115
                        },
                        {
                            month: 'april',
                            peugot: 80,
                            audit: 120,
                            bmw: 75
                        },
                        {
                            month: 'may',
                            peugot: 100,
                            audit: 140,
                            bmw: 80
                        }
                    ];
                    var lastWeek = [
                        {
                            name: "peugot",
                            sales: [
                                { model: 'model1', amount: 100 },
                                { model: 'model2', amount: 200 },
                                { model: 'model3', amount: 300 }
                            ]
                        },
                        {
                            name: "audi",
                            sales: [
                                { model: 'a3', amount: 200 },
                                { model: 'qutro', amount: 300 },
                                { model: 'a8', amount: 100 }
                            ]
                        },
                        {
                            name: "bmw",
                            sales: [
                                { model: 'model5', amount: 200 },
                                { model: 'model8', amount: 100 },
                                { model: 'model3', amount: 150 }
                            ]
                        }
                    ];

                    function CarViewModel(data) {
                        var self = this;
                        self.sales = ko.observableArray([]);
                        self.name = ko.observable();

                        self.totalSales = ko.computed(function() {
                            return d3.sum(self.sales().map(function(item) {
                                return item.amount;
                            }));
                        }, self);

                        if (data != null) {
                            self.sales(data.sales);
                            self.name(data.name);
                        }

                        self.salesChart = ko.computed(function () {
                            return self.sales().map(function (car) {
                                return { x: car.model, y: car.amount };
                            });
                        });
                    }

                    function TestViewModels(data, lastWeekData) {
                        var self = this;

                        self.cars = ko.observableArray([]);
                        self.salesPerMonth = ko.observableArray([]);
                                               
                        //first chart with month x-axis
                        self.salesPerMonthChart = ko.computed(function () {
                            return self.salesPerMonth().map(function (i) {

                                return {
                                    linename: i.linename,
                                    width : 5,
                                    values: i.data.map(function (item) {
                                        return { x: item.month, y: item[i.linename] };
                                    })
                                };
                            });
                        });

                        self.carSales = ko.observableArray([]);

                        self.carSales(data);

                        self.carsChart = ko.computed(function () {
                            return self.cars().map(function (car) {
                                return { x: car.name(), y: car.totalSales() };
                            });
                        });

                        
                        var keys = d3.keys(data[0]).filter(function(i) { return i != 'month' && i!= 'id'; });
                        var perMonth = keys.map(function(key) {
                            return {
                                linename: key,
                                data: data
                            };
                        });

                        self.salesPerMonth(perMonth);

                        var carsVMs = lastWeekData.map(function(x) { return new CarViewModel(x); });
                        self.cars(carsVMs);

                        self.valueToLabel = function (x) {
                            return x + " cars sold";
                        }
                        
                        var simpleData = [];
                        for(var i=0;i<100;i++){
                            simpleData.push({
                                x:i,
                                y:i*2
                            });
                        }
                        self.simpleLine = ko.observableArray([{
                            linename: "test",
                            values: simpleData
                        }]);
                    }

                    var vm = new TestViewModels(carSales, lastWeek);

                    ko.applyBindings(vm);
                });
            });
    </script>
</body>
</html> 