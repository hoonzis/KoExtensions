<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Map Test Page</title>
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
        <script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
        <link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
        <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>

        <script src="../references/require.js"></script>
    </head>
    <body>
        <table>
            <tr>
                <td>
                    <div id="map" style="width:300px;height:300px" data-bind="gmap:points, markerSelected:pointSelected">
                    </div>
                </td>
                <td>
                    <div id="mapbox" style="width:300px;height:300px" data-bind="mapbox:points, mapOptions:{maxZoom:9}">
                    </div>
                </td>
            </tr>
        </table>
        <table>
            <thead>
                <tr>
                    <td>Name</td>
                    <td>Latitude</td>
                    <td>Longitude</td>
                    <td>Selected</td>
                </tr>
            </thead>
            <tbody data-bind="foreach:points">
                <tr>
                    <td><span data-bind="text:name"></span></td>
                    <td><input data-bind="value:lat"/></td>
                    <td><input data-bind="value:lng"/></td>
                    <td><span data-bind="text:selected"></span></td>
                </tr>
            </tbody>
        </table>

        <script>
        require.config({
            baseUrl: "../src",
            paths:{
              'ko':'../references/knockout-3.2.0.debug',
              'd3':'../references/d3',
            }
        });

            var ko;
            require(['koextensions','ko'], function(koext,kol) {
                ko = kol;
                koext.registerExtensions();
                var stationsData = {
                    "stations": [
                        {
                            "lat": 55.16,
                            "lng": 55.335,
                            "name": "Station 1"
                        },
                        {
                            "lat": 55.25,
                            "lng": 55.34,
                            "name": "Station 2"
                        },
                        {
                            "lat": 55.23,
                            "lng": 55.345,
                            "name": "Station 3"
                        }
                    ],
                };

                function PointViewModel(data) {
                    var self = this;
                    self.lat = ko.observable();
                    self.lng = ko.observable();
                    self.name = ko.observable();
                    self.selected = ko.observable();

                    if (data != null) {
                        self.lat(data.lat);
                        self.lng(data.lng);
                        self.name(data.name);
                    }
                }

                function StationListViewModel(json) {
                    var self = this;
                    self.points = ko.observableArray([]);
                    self.selectedPoint = ko.observable();

                    self.pointSelected = function(point){
                        if(self.selectedPoint())
                            self.selectedPoint().selected(false);
                        point.selected(true);
                        self.selectedPoint(point);
                    };

                    self.points(json.stations.map(function(x) { return new PointViewModel(x); }));
                }

                var vm = new StationListViewModel(stationsData);
                L.mapbox.accessToken = 'pk.eyJ1IjoiaG9vbnppcyIsImEiOiJjaWpqNHZmbHgwMDRpdmVtNG9ieWs4Mjg1In0.mKQEXA9KZhJe5w7o-9znEQ';
                ko.applyBindings(vm);
            });


        </script>
    </body>
</html>
